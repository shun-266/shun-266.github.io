<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCV.js Camera Test</title>
    <script async src="opencv.js"></script>
</head>
<body>
    <video id="camera" autoplay playsinline></video>
    <canvas id="output"></canvas>
    <script>
        let video = document.getElementById('camera');
        let canvas = document.getElementById('output');
        let ctx = canvas.getContext('2d');
        let streaming = false;

        const processVideo = () => {
            if (!streaming) return;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            let src = cv.imread(canvas);
            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            cv.imshow('output', gray);
            src.delete();
            gray.delete();

            requestAnimationFrame(processVideo);
        };

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    streaming = true;
                    processVideo();
                });
            })
            .catch(error => {
                console.error("カメラの初期化に失敗しました:", error.name, error.message, error);
            });
    </script>
</body>
</html>
